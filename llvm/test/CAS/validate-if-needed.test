RUN: rm -rf %t && mkdir %t
RUN: llvm-cas --cas %t/cas --ingest %S/Inputs > %t/cas.id
RUN: mv %t/cas/v1.1/v8.data %t/cas/v1.1/v8.data.bak 

# INVALID: bad record
# VALID: validated successfully
# SKIPPED: validation skipped
# RECOVERED: recovered from invalid data

# Validation failures are not saved.
RUN: not llvm-cas --cas %t/cas --validate-if-needed 2>&1 | FileCheck %s -check-prefix=INVALID
RUN: not llvm-cas --cas %t/cas --validate-if-needed 2>&1 | FileCheck %s -check-prefix=INVALID

# Validation happens once per boot.
RUN: mv %t/cas/v1.1/v8.data.bak %t/cas/v1.1/v8.data
RUN: llvm-cas --cas %t/cas --validate-if-needed | FileCheck %s -check-prefix=VALID
RUN: llvm-cas --cas %t/cas --validate-if-needed | FileCheck %s -check-prefix=SKIPPED
# Wrong timestamp triggers re-validation.
RUN: echo '123' > %t/cas/v1.validation
RUN: llvm-cas --cas %t/cas --validate-if-needed | FileCheck %s -check-prefix=VALID
RUN: llvm-cas --cas %t/cas --validate-if-needed | FileCheck %s -check-prefix=SKIPPED
# Skipped validation does not catch errors.
RUN: mv %t/cas/v1.1/v8.data %t/cas/v1.1/v8.data.bak
RUN: llvm-cas --cas %t/cas --validate-if-needed | FileCheck %s -check-prefix=SKIPPED

# Unless forced.
RUN: not llvm-cas --cas %t/cas --validate-if-needed --force 2>&1 | FileCheck %s -check-prefix=INVALID

# Recovering from invalid data.
RUN: llvm-cas --cas %t/cas --validate-if-needed --allow-recovery --force | FileCheck %s -check-prefix=RECOVERED
RUN: ls %t/cas/corrupt.0.v1.1
RUN: llvm-cas --cas %t/cas --validate-if-needed --allow-recovery | FileCheck %s -check-prefix=SKIPPED
RUN: llvm-cas --cas %t/cas --validate-if-needed --force | FileCheck %s -check-prefix=VALID
RUN: rm -rf %t/cas/v1.1
RUN: cp -r %t/cas/corrupt.0.v1.1 %t/cas/v1.1
RUN: mv %t/cas/v1.1/v8.data %t/cas/v1.1/v8.data.bak
RUN: llvm-cas --cas %t/cas --validate-if-needed --allow-recovery --force | FileCheck %s -check-prefix=RECOVERED
RUN: ls %t/cas/corrupt.1.v1.1

# Corrupt data is pruned.
RUN: llvm-cas --cas %t/cas --prune
RUN: not ls %t/cas/corrupt.0.v1.1
RUN: not ls %t/cas/corrupt.1.v1.1
